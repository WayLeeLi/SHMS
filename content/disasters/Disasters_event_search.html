<div>
	<h4>職災通報作業_後台</h4>
	<div class="date_time">

		<button id="add" class="btn btn-primary  my-2">匯入</button>

		<!-- <button id="addx" class="btn btn-success  my-2">每月通報表</button> -->
		<button id="download_btn" class="btn btn-primary  my-2 pull-right">匯出</button>
	</div>
	<div id="jsGrid"></div>
</div>
<div id="tableDialog" style="display:none" class="container">
	<div>



		<form id="inputForm">

			<table class="w-100 safe_form">
				<tbody>

					<tr>
						<td class="table-header " width="200">選擇檔案</td>

					</tr>
					<tr>
				
						<td class="">
							<div class="date_box w_200p">
								<div class="input_file" style="padding: 0;">
									<div class="showFileName"></div>
									<input type="file" id="file1" accept="application/vnd.ms-excel">
									<input type="hidden" id="file1_base64">
									<label for="file1" class="btn btn-primary  my-2" style="margin: 0 !important;">選擇檔案
									</label>
								</div>
							</div>
						</td>


					</tr>

				</tbody>
			</table>
		</form>

	</div>
	<br>
	<div style="text-align: center;">
		<button type="button" id="submitBtn_x" class="btn btn-primary  my-2">匯入</button>

	</div>
</div>

<style>
	/* 讓表格內容換行 */
	.jsgrid-table {
		word-wrap: break-word;
	}

	input[type=text] {
		width: 100%;
	}

	textarea {
		width: 100%;
	}
</style>

<script>
	//需要用的JS
	require(["jquery", "jquery_validate", "jsgrid", "jquery_ui"], function (jquery, jquery_validate, jsgrid, jquery_ui) {
		//頁面讀取後執行
		$(document).ready(function () {
			$('#startDate').datepicker({

				autoclose: true, //選擇後自動關閉
				format: 'yy/mm/dd',
				maxDate: '+0M +0D',
			}).on('changeDate', function (e) {
				var startTime = e.date;
				$('#endDate').datepicker('setStartDate', startTime);
			});
			$('#addx').click(function (){
				Processing('1')
			})
			function Processing(id) {
				bodyHref("/content/disasters/DIsasters_mouth.html");
			}
			$(".input_file").on("change", "input[type='file']", function () {
				var filePath = $(this).val();
				// if (filePath.indexOf("xls") != -1 || filePath.indexOf("xlsx") != -1) {
				$(".fileerrorTip").html("").hide();
				var arr = filePath.split('\\');
				var fileName = arr[arr.length - 1];
				$(this).parent().find(".showFileName").html(fileName);
				// } else {

				// 	return false
				// }
			});
			$("#file1").change(function () {
				var v = $(this).val();
				var reader = new FileReader();
				reader.readAsDataURL(this.files[0]);
				reader.onload = function (e) {
					$('#file1_base64').val(e.target.result);
				};
			});
			var currentDate = new Date();
			var year = currentDate.getFullYear();
			var month = currentDate.getMonth() + 1;
			var day = currentDate.getDate();
			load()
			function load(){
			$.ajax({
				url: "/" + CONFIG.SYSTEM_NAME + '/occupationalDisasters/api/list?year='+year+'&harmCatagory=',
				contentType: "application/json;charset=utf-8", // 因為上面是JSON
				async: false,
				cache: false,
				type: "GET",
				success: function (data, textStatus) {
					if (data.code == 4000) {
							alert('您登入已逾時或未登入，請重新登入！')
							location.href = "/" + CONFIG.SYSTEM_NAME + "/page/login.html";

						}
					if (data && data == "<script>alert('沒有權限')<\/script>") {
						alert("沒有權限");
					} else {
						var data = data.data
						$("#jsGrid").jsGrid({
							width: "100%",
							height: "auto",
							heading: true, //是否顯示表頭
							filtering: false, //啟動查找
							inserting: false, //啟動新增  關掉使用自定義的
							editing: true,  //啟動編輯 
							selecting: true,
							sorting: true, //啟動排序
							paging: true, //啟動分頁 
							pageLoading: false, //是否支援分頁載入資料（相比較paging，這個屬性是向伺服器請求資料時要求分頁，而paging是本機進行分頁，無關伺服器）
							autoload: true,
							pageSize: 10,

							controller: {
								loadData: function (filter) {
									//查詢
									var result = $.grep(data, function (item, idx) {
										for (var key in filter) {
											var value = filter[key];
											if (value.length > 0) {
												if (!item[key]) {
													return false;
												}
												if (typeof item[key] === 'number') {
													if (item[key].toString().indexOf(value) == -1) {
														return false;
													}
												} else if (typeof item[key] === 'string') {
													if (item[key].indexOf(value) == -1) {
														return false;
													}
												}

											}
										}
										return true;
									});
									return result;
								},

							},

							fields: [

								{ title: "案件發生日期", name: "eventDate", type: "text", width: 120 },
								{ title: "單位名稱", name: "unitName", type: "text", width: 120, validate: "required" },
								{ title: "姓名", name: "name", type: "text", width: 100, validate: "required" },
								{ title: "出生年月", name: "birthday", type: "text", width: 100, validate: "required" },
								{ title: "ID", name: "idNumber", type: "text", width: 100 },
								{ title: "身份別（非/原住民）", name: "idCatagory", type: "text", width: 100 },
								{ title: "受傷部位情形", name: "harmBody", type: "text", width: 130 ,classes: "text-ellipsis", itemTemplate: function (value, item) {
											return $("<span>").text(value).attr('title', value).addClass('text-ellipsis')
										}},
								{ title: "災害類型", name: "harmCatagory", type: "text", width: 130 ,classes: "text-ellipsis", itemTemplate: function (value, item) {
											return $("<span>").text(value).attr('title', value).addClass('text-ellipsis')
										}},
								{ title: "媒介物（失能傷害種類）", name: "medium", type: "text", width: 100, classes: "text-ellipsis", itemTemplate: function (value, item) {
											return $("<span>").text(value).attr('title', value).addClass('text-ellipsis')
										}},

								{ title: "本次核准工傷病假期間", name: "period", type: "text", width: 80 },

							],
							rowClick: function (args) {

								// bodyHref("/content/situation/Safetysituationreport_form.html");
								//showDetailsDialog("修改", args.item);
							},
							deleteConfirm: function (item) {
								return "參數\"" + item.NUM + "\"確認刪除?";
							}, loadComplete: function () {
								alert("jqGrid資料載入完之後調用");
							}
						});
					}
				},
				error: function (data, textStatus, errorThrown) {
					console.log(data);
				},
			});}
			$('#download_btn').click(function () {
				download()
			})
			function download() {
				showAlert('檔案下載', '檔案正在下載中，請稍候。', '')
				window.location.href = "/" + CONFIG.SYSTEM_NAME + '/occupationalDisasters/api/export?year=2023&harmCatagory='
			}
			$("#tableDialog").dialog({
				title: "參數設定",
				autoOpen: false,
				width: 550,
				modal: true,
				open: function () {
					$('.ui-widget-overlay').addClass('custom-overlay');
					customCloseBtn();
				},
				close: function () {

					$("#dialogForm").find(".error").removeClass("error");
					$('.ui-widget-overlay').removeClass('custom-overlay');
				},
				classes: dlgSetting.classes,
				show: dlgSetting.show,
				hide: dlgSetting.hide
			});

			var showDetailsDialog = function (dialogType, item) {

				$("#tableDialog").dialog("option", "title", dialogType + "").dialog("open");
			};
$('#add').click(function (){
	showDetailsDialog('匯入檔案','')
})

$("#submitBtn_x").click(function () {
var saveItem = {

	file: $('#file1_base64').val(),
}
insert(saveItem)
})
function insert(data) {
				console.log(JSON.stringify(data))
				$.ajax({
					data: JSON.stringify(data),
					url: "/" + CONFIG.SYSTEM_NAME + '/occupationalDisasters/api/import',
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "POST",
					success: function (data, textStatus) {
						if (data && data.code == 5000) {
							//showAlert('沒有權限','沒有權限','')
							showAlert('沒有權限', '沒有權限', '')
						} if (data && data.code == 1000) {
							//showAlert('沒有權限','沒有權限','')
							showAlert('提示', '檢查日期、TCB帳號、身分證字號不能爲空', '')
						} if (data && data.code == 2000) {
							//showAlert('沒有權限','沒有權限','')
							showAlert('提示', '請選擇檔案後匯入', '')
						}else {
							showAlert('匯入成功', '匯入成功', '')
							console.log(data);
							load()
							$("#tableDialog").dialog("close");
						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			};
			$("#dialogForm").validate({
				//錯誤訊息元素預設為label改成p會換行
				errorElement: "p",
				rules: {
					cfgType: { required: true, rangelength: [2, 50] },
					cfgKey: { required: true, rangelength: [3, 80] },
					cfgName: { required: true, rangelength: [2, 50] },
					cfgValue: { required: true, rangelength: [0, 80] },
					cfgInUse: { required: true }
				},
				messages: {
					cfgType: {
						required: "請輸入參數類型",
						rangelength: "密碼長度不得小於2個字母大於50個字母"
					},
					cfgKey: {
						required: "請輸入參數key",
						rangelength: "參數key不得小於4個字母大於80個字母"
					},
					cfgName: {
						required: "請輸入參數名稱",
						rangelength: "參數名稱不得小於2個字母大於50個字母"
					},
					cfgValue: {
						required: "請輸入參數值",
						rangelength: "參數值不得小於0個字母大於80個字母"
					},
					cfgInUse: {
						required: "請選擇是否啟用"
					}
				},
				submitHandler: function () {
					formSubmitHandler();
				}
			});



		});

		var cellIndex = parseInt($(".tbStyle th").length) - 1;
		$("#jsGrid tr td").each(function () {
			alert($(this).text())
			if (this.cellIndex != cellIndex) {
				$(this).attr("title", $(this).text());
				//alert($(this).parent().get(0).rowIndex);輸出所在行
			}
		});
	});
</script>
