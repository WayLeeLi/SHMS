<div class="calendar-look">
	<h4>臨場健康訪視排程</h4>

	<div id="calendar"></div>
</div><input type="hidden" name="addOredit">
<input type="hidden" name="id" id="id">
<input type="hidden" name="scheduleDate" id="scheduleDate">
<input type="hidden" name="unitId">
<div id="tableDialog" style="display:none" class="container">
	<div>
		<h2 style="text-align: center;"><span class="s_unitName"></span>-臨場健康訪視排程</h2>
		<br>
		<div class="con-tab">
			<ul>
				<li class="con-active" data-role="tab1">預約資料</li>
				<li data-role="tab2">訪視表單</li>
			</ul>
			<div class="con-tab-cotent">
				<div class="con-tabx con-tab1" style="display: block;">
					<div id="jsgrid_yy"></div>
				</div>
				<div class="con-tabx con-tab2">
					<div id="printDiv0">
						<form id="inputForm">
							<h2>附表八：勞工健康服務執行紀錄表</h2>

							<br />
							<table class="w-100 safe_form">
								<tbody>

									<tr>

										<td class="" colspan="2">
											作業場所基本資料
										</td>

									</tr>
									<tr>
										<td class="table-header " width="200">部門名稱：</td>
										<td class="">
											<input type="text" name="unitName" disabled>
										</td>

									</tr>
									<tr>
										<td class="table-header " width="200">作業人員</td>
										<td class="">
											<p> <input type="checkbox" value="是" name="isAdministrative">行政人員：男 <input
													type="text" name="administrativeManNumber" class="w_100p"> 人；女
												<input type="text" name="administrativeWomenNumber" class="w_100p"> 人；
											</p>
											<p> <input type="checkbox" value="是" name="isOperators">現場操作人員：男 <input
													type="text" name="operatorsManNumber" class="w_100p"> 人；女 <input
													type="text" name="operatorsWomanNumber" class="w_100p"> 人；</p>
										</td>

									</tr>
									<tr>
										<td class="table-header " width="200">作業類別與人數</td>
										<td class="">
											<p> <input type="checkbox" value="是" name="isGeneral">一般作業：人數 <input
													type="text" name="generalOperatorsNumber" class="w_100p"> 人；</p>

										</td>

									</tr>
									<tr>

										<td class="" colspan="2">
											<p>二、作業場所與勞動條件概況:工作流程（製程）、工作型態與時間、人員及危害概述</p>
											<textarea placeholder="工作流程（製程）、工作型態與時間、人員及危害概述"
												name="overviewOfWorkplace"></textarea>
										</td>

									</tr>
									<tr>

										<td class="" colspan="2">
											<p>三、臨場健康服務執行情形（本規則第九條至第十三條事項）:</p>
											<p>（一）辦理事項</p>
											<textarea placeholder="" name="handlingMatters"></textarea>
											<p>（二）發現問題</p>
											<textarea placeholder="" name="discoverProblems"></textarea>
										</td>

									</tr>
									<tr>

										<td class="" colspan="2">
											<p>四、建議執行措施：（針對發現問題所執行之措施）</p>
											<textarea placeholder="" name="suggestedImplementation"></textarea>
										</td>

									</tr>
									<tr>

										<td class="" colspan="2">
											<p>五、對於前次建議改善事項之追蹤辦理情形:</p>
											<textarea placeholder="" name="previousTracking"></textarea>
										</td>

									</tr>
									<tr>

										<td class="" colspan="2">
											<p>六、執行人員及日期（僅就當次實際執行者簽章）</p>
											<p><input type="checkbox" value="是"
													name="isServicePhysician">1.勞工健康服務醫師，簽章<input type="text"
													name="servicePhysicianName" class="w_100p"></p>
											<p><input type="checkbox" value="是"
													name="isNursingStaff">2.勞工健康服務護理人員，簽章<input type="text"
													name="nursingStaffName" class="w_100p"></p>
											<p><input type="checkbox" value="是"
													name="isServiceRelated">3.勞工健康服務相關人員，簽章<input type="text"
													name="serviceRelatedName" class="w_100p"></p>
											<p><input type="checkbox" value="是"
													name="isOccupationalSafety">4.職業安全衛生人員，簽章<input type="text"
													name="occupationalSafetyName" class="w_100p"></p>
											<p><input type="checkbox" value="是"
													name="isManagementPersonnel">5.人力資源部管理人員，簽章<input type="text"
													name="managementPersonnelName" class="w_100p"></p>
											<p>6.單位主管<input type="text" name="unitSupervisorTitle" class="w_100p">
												<!-- ，簽章<input type="text" name="" class="w_100p"> -->
											</p>
											<!-- <p>部門名稱<input type="text" name="unitSupervisorTitle" class="w_100p">，主管職稱<input type="text" name="" class="w_100p">，簽章<input type="text" name="" class="w_100p"></p> -->

										</td>
									<tr>
										<td class="table-header " width="200">執行日期：</td>
										<td class="">
											<div class="date_box">
												<label>
													<input id="startDate" name="executionDate" type="text"
														readonly="readonly" class="w_100p" placeholder="" />
													<i class="iconfont icon-riqi1"></i>
												</label>
											</div>
										</td>

									</tr>
									<tr>
										<td class="table-header " width="200">執行時間：</td>
										<td class="">
											<input type="text" name="executionStartHours" class="w_100p"> 時<input
												type="text" name="executionStartMinutes" class="w_100p"> 分 迄
											<input type="text" name="executionEndHours" class="w_100p"> 時<input
												type="text" name="executionEndMinutes" class="w_100p"> 分

										</td>

									</tr>
									</tr>

								</tbody>
							</table>
						</form>
						<br>
						

					</div><div style="text-align: center;">

							<button type="button" id="submitBtn" class="btn btn-success  my-2">送出</button>

							<button type="button" id="printBtn" class="btn btn-secondary  my-2">列印</button>
						</div>
				</div>
			</div>
		</div>
	</div>

</div>
<template>
	<div style="width:100%;height:100%">
		<FullCalendar ref="FullCalendar" :options="calendarOptions" class="eventDeal-wrap">
			<template #eventContent="arg">
				<el-tooltip placement="top" effect="light">
					<div slot="content">【開始時間】: {{ momentFormat(arg.event.start) }}<br />【結束時間】: {{
						momentFormat(arg.event.end) }}<br />【備註】: {{arg.event.extendedProps.remark}}</div>
					<div style="text-align:left;">
						<el-button type="danger" class='el-buttons'
							style="background-color:#F56C6C;width:20px;height:20px;padding:2px"
							@click.stop="deleteEvent(arg.event)" icon="el-icon-delete" size="mini" circle></el-button>
						{{arg.event.title}}
					</div>
				</el-tooltip>
			</template>
		</FullCalendar>
		<el-dialog :visible.sync="dialogShow" :destroy-on-close="true" :close-on-press-escape="false"
			:close-on-click-modal="false" width="600px" :title="dialogTitle" height="500px" @close="close">
			<el-form :model="BusinessModel" label-width="140px" ref="ruleForm" size="medium" :rules="rules">
				<el-row :gutter="20">
					<el-col :offset="0">
						<el-form-item label="標題：" prop="title" class="is-required">
							<el-input v-model="BusinessModel.title"> </el-input>
						</el-form-item>
					</el-col>
				</el-row>
				<el-row :gutter="20">
					<el-col :offset="0">
						<el-form-item label="涉及時段:" prop="task_type" class="is-required">
							<el-select v-model="BusinessModel.task_type" placeholder="選擇時段" filterable>
								<el-option v-for="(key, val) in productTaskType" :key="key" :label="val" :value="key">
								</el-option>
							</el-select>
						</el-form-item>
					</el-col>
				</el-row>
				<el-row :gutter="20">
					<el-col :offset="0">
						<el-form-item label="時間範圍：" prop="times" class="is-required">
							<el-date-picker size="medium" v-model="BusinessModel.times" type="datetimerange"
								align="right" start-placeholder="起始時間" end-placeholder="結束時間"
								:default-time="['00:00:00', '23:59:59']" @change="dateChange($event, BusinessModel)">
							</el-date-picker>
						</el-form-item>
					</el-col>
				</el-row>
				<el-row :gutter="20">
					<el-col :offset="0">
						<el-form-item label="備註" prop="remark">
							<el-input type="textarea" :rows="15" v-model="BusinessModel.remark"> </el-input>
						</el-form-item>
					</el-col>
				</el-row>
			</el-form>
			<div slot="footer" class="dialog-footer">
				<div style="float: left; color: blue">注意:帶*選項表示必填項</div>
				<el-button v-on:click="dialogShow = false">取 消</el-button>
				<el-button type="primary" v-on:click="onSave()">確 定</el-button>
			</div>
		</el-dialog>
	</div>
</template>

<style>
	/* 讓表格內容換行 */
	.jsgrid-table {
		word-wrap: break-word;
	}

	input[type=text] {
		width: 100%;
	}

	textarea {
		width: 100%;
	}
</style>

<script>
	//需要用的JS
	require(["jquery", "jquery_validate", "jsgrid", "jquery_ui", "moment", "fullcalendartext","timepicker",], function (jquery, jquery_validate, jsgrid, jquery_ui, moment, fullcalendartext,timepicker) {
		//頁面讀取後執行
		$(document).ready(function () {
			function createSelect(id, data, key, val, eventKey) {
				$.each(data, function (index, item) {
					$('#' + id).append($('<option>').val(item[key]).text(eventKey ? item[eventKey] + "_" + item[val] : item[val]));
					$('#' + id + '1').append($('<a>').html(item[val]).addClass('dropdown-item'));
				});
			}
			$(".con-tab>ul li").click(function () {
				$(this).addClass('con-active')
				$(this).siblings().removeClass('con-active')
				$('.con-'+$(this).data("role")).show();
				$('.con-'+$(this).data("role")).siblings().hide();
			})
			$("#printBtn").click(function () {
				//printByDiv(document.getElementById("printDiv"));
				printJS({ 
					printable: 'printDiv0', 
					type: 'html', 
					header: '' ,
					css:'../resources/css/print.css',
		
		
		 
				})
			});
		
$("#startDate").datetimepicker({
				changeMonth: true,
				changeYear: true,
				dateFormat: "yy/mm/dd",
				//timeFormat: "HH:mm:ss",
			});
			insert_mr()
			//取得默認資料
			function insert_mr() {
				let id = 0;
				$("#id").val(id);
				$.ajax({
					data: JSON.stringify({ "safetyNo": "" }),
					url: "/" + CONFIG.SYSTEM_NAME + '/safetyMaintenance/api/getInitData',
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "POST",
					success: function (data, textStatus) {
						if (data && data == "<script>alert('沒有權限')<\/script>") {
							//showAlert('沒有權限','沒有權限','')
							showAlert('沒有權限', '沒有權限', '')
						} else {
							var data = data.unitList
							console.log(data);
							createSelect("eventName", data, 'unitId', 'unitName', '');
						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			};
			$('#submitBtn').click(function () {
				var saveItem = {
					id: $("#id").val(),
					scheduleDate: $("*[name='scheduleDate']").val(),
					// unitName: $("*[name='unitName']").val(),
					unitName: $("*[name='unitName']").val(),
					unitId: $("*[name='unitId']").val(),
					administrativeManNumber: $("*[name='administrativeManNumber']").val(),
					administrativeWomenNumber: $("*[name='administrativeWomenNumber']").val(),
    operatorsManNumber: $("*[name='operatorsManNumber']").val(),
    operatorsWomanNumber: $("*[name='operatorsWomanNumber']").val(),
    generalOperatorsNumber: $("*[name='generalOperatorsNumber']").val(),
    overviewOfWorkplace: $("*[name='overviewOfWorkplace']").val(),
    handlingMatters: $("*[name='handlingMatters']").val(),
    discoverProblems: $("*[name='discoverProblems']").val(),
    suggestedImplementation: $("*[name='suggestedImplementation']").val(),
    previousTracking: $("*[name='previousTracking']").val(),
    isServicePhysician: $("*[name='isServicePhysician']").val(),
    nursingStaffName: $("*[name='nursingStaffName']").val(),
    serviceRelatedName: $("*[name='serviceRelatedName']").val(),
    occupationalSafetyName: $("*[name='occupationalSafetyName']").val(),
    managementPersonnelName: $("*[name='managementPersonnelName']").val(),
    unitSupervisorTitle: $("*[name='unitSupervisorTitle']").val(),
    executionDate: $("*[name='executionDate']").val(),
    executionStartHours: $("*[name='executionStartHours']").val(),
    executionStartMinutes: $("*[name='executionStartMinutes']").val(),
    executionEndHours: $("*[name='executionEndHours']").val(),
    executionEndMinutes: $("*[name='executionEndMinutes']").val(),
	servicePhysicianName: $("*[name='servicePhysicianName']").val(),
	isAdministrative: $("*[name='isAdministrative']:checked").val(),
	isOperators: $("*[name='isOperators']:checked").val(),
	isGeneral: $("*[name='isGeneral']:checked").val(),
	isServicePhysician: $("*[name='isServicePhysician']:checked").val(),
	isNursingStaff: $("*[name='isNursingStaff']:checked").val(),
	isServiceRelated: $("*[name='isServiceRelated']:checked").val(),
	isOccupationalSafety: $("*[name='isOccupationalSafety']:checked").val(),
	isManagementPersonnel: $("*[name='isManagementPersonnel']:checked").val(),


    status: "n",
    version: "1.0.0"
				}
				var saveItem1 = {
					scheduleDate: $("*[name='scheduleDate']").val(),
					unitName: $("*[name='unitName']").val(),
					unitId: $("*[name='unitId']").val(),
					administrativeManNumber: $("*[name='administrativeManNumber']").val(),
					administrativeWomenNumber: $("*[name='administrativeWomenNumber']").val(),
    operatorsManNumber: $("*[name='operatorsManNumber']").val(),
    operatorsWomanNumber: $("*[name='operatorsWomanNumber']").val(),
    generalOperatorsNumber: $("*[name='generalOperatorsNumber']").val(),
    overviewOfWorkplace: $("*[name='overviewOfWorkplace']").val(),
    handlingMatters: $("*[name='handlingMatters']").val(),
    discoverProblems: $("*[name='discoverProblems']").val(),
    suggestedImplementation: $("*[name='suggestedImplementation']").val(),
    previousTracking: $("*[name='previousTracking']").val(),
    isServicePhysician: $("*[name='isServicePhysician']").val(),
    nursingStaffName: $("*[name='nursingStaffName']").val(),
    serviceRelatedName: $("*[name='serviceRelatedName']").val(),
    occupationalSafetyName: $("*[name='occupationalSafetyName']").val(),
    managementPersonnelName: $("*[name='managementPersonnelName']").val(),
    unitSupervisorTitle: $("*[name='unitSupervisorTitle']").val(),
    executionDate: $("*[name='executionDate']").val(),
    executionStartHours: $("*[name='executionStartHours']").val(),
    executionStartMinutes: $("*[name='executionStartMinutes']").val(),
    executionEndHours: $("*[name='executionEndHours']").val(),
    executionEndMinutes: $("*[name='executionEndMinutes']").val(),
	servicePhysicianName: $("*[name='servicePhysicianName']").val(),
	isAdministrative: $("*[name='isAdministrative']:checked").val(),
	isOperators: $("*[name='isOperators']:checked").val(),
	isGeneral: $("*[name='isGeneral']:checked").val(),
	isServicePhysician: $("*[name='isServicePhysician']:checked").val(),
	isNursingStaff: $("*[name='isNursingStaff']:checked").val(),
	isServiceRelated: $("*[name='isServiceRelated']:checked").val(),
	isOccupationalSafety: $("*[name='isOccupationalSafety']:checked").val(),
	isManagementPersonnel: $("*[name='isManagementPersonnel']:checked").val(),


    status: "n",
    version: "1.0.0"
				}

				insert($("*[name='addOredit']").val(), saveItem, saveItem1)
			})
			//送出
			function insert(addOredit, data, data1) {
				
				if (addOredit == '新增') {
					var url = 'healthAppointmentServiceExecute/api/save'
					var data= JSON.stringify(data1)
					console.log(data)
				}
				if (addOredit == '檢視') {
					var url = 'healthAppointmentServiceExecute/api/update'
					var data= JSON.stringify(data)
					console.log(data)
				}
				$.ajax({
					data:data,
					url: "/" + CONFIG.SYSTEM_NAME + '/' + url,
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "POST",
					success: function (data, textStatus) {
						if (data && data.code == 5000) {
							//showAlert('沒有權限','沒有權限','')
							showAlert('沒有權限', '沒有權限', '')
						}if (data && data.code == 7000) {
							//showAlert('沒有權限','沒有權限','')
							showAlert('請正確填寫', '請正確填寫相關資料！', '')
						} else {
							
							showAlert('成功', '勞工健康服務執行紀錄表更新成功', bodyHref("/content/health/Health_contact_text.html"))
							
							console.log(data);

						}
					},
					error: function (data, textStatus, errorThrown) {
						//console.log(data);
					},
				});
			};

			get_list()
			function get_list() {
				var currentDate = new Date();
				var year = currentDate.getFullYear();
				var month = currentDate.getMonth() + 1;
				var monthprev = currentDate.getMonth();
				var day = currentDate.getDate();
				var get = year + '/' + month + '/' + day

				var calendar = $('#calendar').fullCalendar({
					header: {													//設置日曆頭部訊息，false，則不顯示頭部訊息。包括left，center,right左中右三個位置
						left: 'prev,next, today',								//上一個、下一個、今天
						center: 'title',										//標題
						right: 'month,agendaWeek,agendaDay,listMonth'			//月、周、日、日程列表
					},
					locale: 'zh-tw',											//?沒用？
					timeFormat: 'HH:mm',										//日程事件的時間格式
					//      timeFormat: 'HH:mm{ - H:mm}',{agenda: 『h:mm{ - h:mm}}
					buttonText: {    											//各按鈕的顯示文字資料
						today: '今天',
						month: '月',
						agendaWeek: '周',
						agendaDay: '日',
						listMonth: '日程',
					},

					monthNames: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"],    	//月份全稱
					monthNamesShort: ["1月", "2月", "3月", "4月", "5月", "6月", "7月", "8月", "9月", "10月", "11月", "12月"], //月份簡寫
					dayNames: ["周日", "週一", "週二", "週三", "週四", "週五", "週六"],    	//周全稱
					dayNamesShort: ["周日", "週一", "週二", "週三", "週四", "週五", "週六"],  //周簡寫
					noEventsMessage: "當月無資料",   							//listview視圖下，無資料提示
					allDayText: "全天",											//自定義全天視圖的名稱
					allDaySlot: false,  										//是否在周日曆上方顯示全天
					//      allDayDefault: false,										//是否為全天日程事件，顯示這一天中所做的事情
					slotDuration: "00:30:00",      							//一格時間槽代表多長時間，默認00:30:00（30分鐘）
					slotLabelFormat: "H(:mm)a",    							//日期視圖左邊那一列顯示的每一格日期時間格式
					slotLabelInterval: "01:00:00", 							//日期視圖左邊那一列多長間隔顯示一條日期文字(默認跟著slotDuration走的，可自定義)
					snapDuration: "01:00:00",      							//其實就是動態創建一個日程時，默認創建多長的時間塊
					firstDay: 1,   												//一周中顯示的第一天是哪天，周日是0，週一是1，類推
					hiddenDays: [],												//隱藏一周中的某一天或某幾天，數組形式，如隱藏週二和週五：[2,5]，默認不隱藏，除非weekends設置為false。
					weekends: true,												//是否顯示週六和周日，設為false則不顯示週六和周日。默認值為true
					weekMode: 'fixed',											//月視圖中顯示周的模式，因每月周數不同月視圖高度不定。fixed：固定顯示6周高，日曆高度保持不變liquid：不固定周數，高度隨周數變化variable：不固定周數，但高度固定
					weekNumbers: false,											//是否在日曆中顯示周次(一年中的第幾周)，如果設置為true，則會在月視圖的左側、周視圖和日視圖的左上角顯示周數。
					weekNumberCalculation: 'iso',								//周次的顯示格式。
					height: 800,												//設置日曆的高度，包括header日曆頭部，默認未設置，高度根據aspectRatio值自適應。
					//      contentHeight: 600,											//設置日曆主體內容的高度，不包括header部分，默認未設置，高度根據aspectRatio值自適應。
					handleWindowResize: true,									//是否隨瀏覽器視窗大小變化而自動變化。
					defaultView: 'month',										//初始化時默認視圖，默認是月month，agendaWeek是周，agendaDay是當天
					//      slotEventOverlap: false,									//事件是否可以重疊覆蓋
					defaultDate: get,											//默認顯示那一天的日期視圖getDates(true)2023-11-10
					nowIndicator: true,            								//周/日視圖中顯示今天當前時間點（以紅線標記），默認false不顯示
					eventLimit: false,       									//資料條數太多時，限制顯示條數（多餘的以「+2more」格式顯示），默認false不限制,支援輸入數字設定固定的顯示條數
					eventLimitText: "更多",       								//當一塊區域內容太多以"+2 more"格式顯示時，這個more的名稱自定義（應該與eventLimit: true一並用）
					dayPopoverFormat: "YYYY年M月d日", 							//點開"+2 more"彈出的小視窗標題，與eventLimitClick可以結合用
					render: function (view) {										//method,綁定日曆到id上。$('#id').fullCalendar('render');
						console.log('render', view)
					},
					events: function (start, end, timezone, callback) {
						$.ajax({
							url: "/" + CONFIG.SYSTEM_NAME + '/healthSchedule/api/listCount?startDate=&endDate=',
							contentType: "application/json;charset=utf-8", // 因為上面是JSON
							async: false,
							cache: false,
							type: "GET",
							success: function (data) { // 獲取當前月的資料
								var events = [];
								$.each(data.data, function (i, value) {
									events.push({
										title: value.unitName+':'+value.userCount+'人',
										userCount: value.userCount,
										start: value.start.replace(/\//g, '-'), // will be parsed
										end: value.end.replace(/\//g, '-'),
										// start: '2024-03-15T00:00:00',
										// end: '2024-03-15T23:59:59',
										id: value.unitId,
									});
								});

								callback(events);
							}
						});
					},
					dayClick: function (date, allDay, jsEvent, view) {						//空白的日期區點擊
						//        	alert($.fullCalendar.formatDate(date, "YYyy/mm/dd"));
						//      	console.log('Clicked on: ' + date.format());
					},
					eventClick: function (event, jsEvent) {									//日程事件點擊
						//alert(event.title + event.start.format() + '______' + event.end.format() + '_______' + " ——詳情");
						console.log()
						showEdit("新增", event.id, event.title, event.start.format());
						//狀態判斷？？？
						//權限限製？？？
					},
					eventMouseover: function () { },						//滑鼠滑過和離開的事件，用法和參數同上
					eventMouseout: function () { },
					selectable: true,									//是否允許通過單擊或拖動選擇日曆中的對象，包括天和時間
					selectHelper: true,   								//當點擊或拖動選擇時間時，是否預先畫出「日程區塊」的樣式顯示默認載入的提示訊息，該屬性只在周/天視圖裡可用
					selectMirror: true,									//鏡像
					selectOverlap: true,       						//是否允許選擇被事件佔用的時間段，默認true可佔用時間段
					selectAllow: function (selectInfo) { 				//精確的控制可以選擇的地方，返回true則表示可選擇，false表示不可選擇
						console.log("start:" + selectInfo.start.format() + "|end:" + selectInfo.end.format() + "|resourceId:" + selectInfo.resourceId);
						return true;
					},
					select: function (start, end, allDay) {				//點擊空白區域/選擇區域內容觸發
						//	        window.location.href= 'apply.html?start=' + start.format() + '?end=' + end.format();
						// var title = prompt(start.format() + '————' + end.format() + '標題標題:');
						// if (title) {
						// 	calendar.fullCalendar('renderEvent', {		//一旦日曆重新取得日程源，則原有日程將消失，當指定stick為true時，日程將永久的保存到日曆上
						// 		title: title,
						// 		start: start,
						// 		end: end,
						// 		allDay: allDay,
						// 		//					rendering: 'background',
						// 		block: true,
						// 	}, true);									//為true時，日程將永久的保存到日曆上，讓事件「持久」
						// }
						//showDetailsDialog("新增", start.format(), '');
						//	        calendar.unselect()
					},
					//		select: function(startDate, endDate, allDay, jsEvent, view ) {			//被選中
					////			startDate：被選中區域的開始時間
					////			endDate：被選中區域的結束時間
					////			allDay：是否為全天事件
					////			jsEvent：jascript對象
					////			view：當前視圖對象
					//			var selectStart = $.fullCalendar.formatDate(startDate,'YYyy/mm/dd HH:mm');
					//			var selectEnd =$.fullCalendar.formatDate(endDate,'YYyy/mm/dd HH:mm');
					//			alert(selectStart + ' 至 ' + selectEnd);
					//			$("#calendar").fullCalendar('renderEvent',true); 
					//		},
					unselect: function (view, jsEvent) {						//選擇取消時觸發
						console.log("");
						console.log("view:" + view);
					},
					lazyFetching: true,        							//是否啟用懶載入技術--即只取當前條件下的視圖資料，其它資料在切換時觸發，默認true只取當前視圖的，false是取全視圖的
					defaultTimedEventDuration: "02:00:00",     			//在Event Object中如果沒有end參數時使用，如start=7:00pm，則該日程對象時間範圍就是7:00~9:00
					defaultAllDayEventDuration: { days: 1 },  				//默認1天是多長，（有的是採用工作時間模式，所以支援自定義）
					//		loading: function(isLoading, view) {
					//      	document.getElementById('載入').style.display =
					//        	isLoading ? 'block' : 'none';
					//			console.log("");
					//	        if(isLoading == true){
					//	            console.log("view:"+view+",開始載入");
					//	        }else if(isLoading == false){
					//	            console.log("view:"+view+",載入完成");
					//	        }else{
					//	            console.log("view:"+view+",除非天塌下來否則不會進這個分支");
					//	        }
					//    	},
					editable: false,                 						//支持日程拖動修改，默認false
					//      eventStartEditable : true,      						//日程開始時間可以改變，默認true，如果是false其實就是指日程塊不能隨意拖動，只能上下拉伸改變他的endTime
					//      eventDurationEditable : false,  						//日程的開始結束時間距離是否可以改變，默認true，如果是false則表示開始結束時間範圍不能拉伸，只能拖拽
					dragOpacity: 0.2,                						//拖拽時不透明度，0.0~1.0之間，數字越小越透明
					dragScroll: true,              						//是否在拖拽時自動移動容器，默認true
					eventOverlap: true,            						//拖拽時是否重疊
					eventConstraint: {     								//限制拖拽拖放的位置（即限制有些地方拖不進去）t
						//          start: '10:00',     								//開始時間10點
						//          end: '18:00',       								//結束時間18點
						dow: [1, 2, 3, 4, 5, 6, 0] 						//0是周日，1是週一，以此類推
					},
					longPressDelay: 1000,  								//移動設備，長按多少毫秒即可拖動,默認1000毫秒（1S）
					eventDragStart: function (event, jsEvent, ui, view) {    //日程開始拖拽時觸發
						//          console.log("eventDragStart():"+event.title);
					},
					eventDragStop: function (event, jsEvent, ui, view) {     //日程拖拽停止時觸發
						//          console.log("eventDragStop():"+event.title);
					},
					eventDrop: function (event, dayDelta, delta, revertFunc, jsEvent, ui, view) {  //日程拖拽停止，並且時間改變時觸發，ayDelta日程前後移動了多少天
						//          console.log("eventDrop():"+event.title);
						console.log('eventDrop被執行，Event的title是：', event.title);
						if (dayDelta._days != 0) {
							console.log('eventDrop被執行，Event的start和end時間改變了：', dayDelta._days + '天！');
						} else if (dayDelta._milliseconds != 0) {
							console.log('eventDrop被執行，Event的start和end時間改變了：', dayDelta._milliseconds / 1000 + '秒！');
						} else {
							console.log('eventDrop被執行，Event的start和end時間沒有改變！');
						}
						//revertFunc();
					},
					eventResizeStart: function (event, jsEvent, ui, view) { //日程大小調整開始時觸發
						//console.log("eventResizeStart():"+event.title);
					},
					eventResizeStop: function (event, jsEvent, ui, view) {     //日程大小調整停止時觸發
						//          console.log("eventResizeStop():"+event.title);
					},
					eventResize: function (event, delta, revertFunc, jsEvent, ui, view) {    //日程大小調整完成並已經執行更新時觸發
						//          console.log("eventResize():"+event.title);
					},

				});
			}


			function removeCharFromString(str, charToRemove) {  
    return str.replace(new RegExp(charToRemove, 'g'), '');  
}  

			$("#tableDialog").dialog({
				title: "參數設定",
				autoOpen: false,
				width: 950,
				height: 600,
				modal: true,
				open: function () {
					$('.ui-widget-overlay').addClass('custom-overlay');
					customCloseBtn();
				},
				close: function () {
					bodyHref("/content/health/Health_contact_text.html")
					$("#dialogForm").find(".error").removeClass("error");
					$('.ui-widget-overlay').removeClass('custom-overlay');
				},
				classes: dlgSetting.classes,
				show: dlgSetting.show,
				hide: dlgSetting.hide
			});

			var formSubmitHandler = $.noop;

			var showEdit = function (dialogType, unitId, unitName, date) {
				
				var str = date;
				var cutChar = "T";
				var result;
				var strx = unitName;
				var cutCharx = ":";
				var resultx;
				result = str.split(cutChar)[0];
				resultx = strx.split(cutCharx)[0];
				resultx1 = strx.split(cutCharx)[1];
				var newString = removeCharFromString(resultx1, "人"); 
				
				$('input[name="generalOperatorsNumber"]').val(newString)
				$("#tableDialog").dialog("option", "title", resultx + "").dialog("open");
				$(".s_unitName").html(resultx)
				get_listx(unitId,resultx,result)
		
				console.log('/healthAppointmentServiceExecute/api/getByDateAndUnit?date='+result.split("-").join("/")+'&unitId='+unitId)
$.ajax({
	url: "/" + CONFIG.SYSTEM_NAME + '/healthAppointmentServiceExecute/api/getByDateAndUnit?date='+result.split("-").join("/")+'&unitId='+unitId,
	contentType: "application/json;charset=utf-8", // 因為上面是JSON
	async: false,
	cache: false,
	type: "GET",
	success: function (data, textStatus) {
		console.log(data)
		if (data && data.code == "5000") {
			showAlert('沒有權限', '沒有權限', '')
		}if (data && data.code == "7001") {
			$('*[name="unitId"]').val(unitId)
			$('*[name="unitName"]').val(resultx)
				$('*[name="executionDate"]').val(result)
				$("*[name='scheduleDate']").val(result)
				$("*[name='addOredit']").val('新增')
		} if (data && data.code == "0") { 
			//console.log(data.data);
			var data = data.data;
			console.log(data)
			$("*[name='addOredit']").val('檢視')
			$("*[name='id']").val(data.id)
			$("*[name='scheduleDate']").val(data.scheduleDate)
			$("*[name='unitName']").val(data.unitName)
			$("*[name='unitId']").val(data.unitId)
			$("*[name='administrativeManNumber']").val(data.administrativeManNumber)
			$("*[name='administrativeWomenNumber']").val(data.administrativeWomenNumber)
			$("*[name='operatorsManNumber']").val(data.operatorsManNumber)
			$("*[name='operatorsWomanNumber']").val(data.operatorsWomanNumber)
			$("*[name='generalOperatorsNumber']").val(data.generalOperatorsNumber)
			$("*[name='executionStartHours']").val(data.executionStartHours)
			$("*[name='executionStartMinutes']").val(data.executionStartMinutes)

			$("*[name='executionEndHours']").val(data.executionEndHours)
			$("*[name='executionEndMinutes']").val(data.executionEndMinutes)


			$("*[name='overviewOfWorkplace']").val(data.overviewOfWorkplace)
			$("*[name='handlingMatters']").val(data.handlingMatters)
			$("*[name='discoverProblems']").val(data.discoverProblems)
			$("*[name='suggestedImplementation']").val(data.suggestedImplementation)
			$("*[name='previousTracking']").val(data.previousTracking)
			$("*[name='isServicePhysician']").val(data.isServicePhysician)
			$("*[name='nursingStaffName']").val(data.nursingStaffName)
			$("*[name='serviceRelatedName']").val(data.serviceRelatedName)
			$("*[name='occupationalSafetyName']").val(data.occupationalSafetyName)
			$("*[name='managementPersonnelName']").val(data.managementPersonnelName)
			$("*[name='unitSupervisorTitle']").val(data.unitSupervisorTitle)
			$("*[name='executionDate']").val(data.executionDate)
			$("*[name='servicePhysicianName']").val(data.servicePhysicianName)


			$("*[name='isAdministrative'][value='" + data.isAdministrative + "']").attr('checked', true)
			$("*[name='isOperators'][value='" + data.isOperators + "']").attr('checked', true)
			$("*[name='isGeneral'][value='" + data.isGeneral + "']").attr('checked', true)
			$("*[name='isServicePhysician'][value='" + data.isServicePhysician + "']").attr('checked', true)
			$("*[name='isNursingStaff'][value='" + data.isNursingStaff + "']").attr('checked', true)
			$("*[name='isServiceRelated'][value='" + data.isServiceRelated + "']").attr('checked', true)
			$("*[name='isOccupationalSafety'][value='" + data.isOccupationalSafety + "']").attr('checked', true)
			$("*[name='isManagementPersonnel'][value='" + data.isManagementPersonnel + "']").attr('checked', true)

		}
	}
});
			};
function get_listx(unitId,unitName,date) {
				$.ajax({
					url: "/" + CONFIG.SYSTEM_NAME + '/healthAppointment/api/listAll?startDate='+date+'&endDate='+date+'&unitId='+unitId+'&unitName='+unitName,
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "GET",
					success: function (data, textStatus) {
						console.log(data)
						if (data && data == "<script>alert('沒有權限')<\/script>") {
							alert("沒有權限");
						} else {
							var data = data.data
							console.log(data)
							$("#jsgrid_yy").jsGrid({
								width: "100%",
								height: "auto",
								heading: true, //是否顯示表頭
								filtering: false, //啟動查找
								inserting: false, //啟動新增  關掉使用自定義的
								editing: true,  //啟動編輯 
								selecting: true,
								sorting: true, //啟動排序
								paging: true, //啟動分頁 
								pageLoading: false, //是否支援分頁載入資料（相比較paging，這個屬性是向伺服器請求資料時要求分頁，而paging是本機進行分頁，無關伺服器）
								autoload: true,
								pageSize: 10,

								controller: {
									loadData: function (filter) {
										//查詢
										var result = $.grep(data, function (item, idx) {
											for (var key in filter) {
												var value = filter[key];
												if (value.length > 0) {
													if (!item[key]) {
														return false;
													}
													if (typeof item[key] === 'number') {
														if (item[key].toString().indexOf(value) == -1) {
															return false;
														}
													} else if (typeof item[key] === 'string') {
														if (item[key].indexOf(value) == -1) {
															return false;
														}
													}

												}
											}
											return true;
										});
										return result;
									},

								},

								fields: [
									{ title: "姓名", name: "name", type: "text", validate: "required" },
									{ title: "單位", name: "unitName", type: "text", validate: "required" },
									{ title: "日期", name: "appointmentDate", type: "text", },
					

								],
								rowClick: function (args) {

									// bodyHref("/content/situation/Safetysituationreport_form.html");
									//showDetailsDialog("修改", args.item);
								},
								deleteConfirm: function (item) {
									return "參數\"" + item.NUM + "\"確認刪除?";
								},
							});
						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			}

		});
		

		var cellIndex = parseInt($(".tbStyle th").length) - 1;
		$("#jsgrid_yy tr td").each(function () {
			alert($(this).text())
			if (this.cellIndex != cellIndex) {
				$(this).attr("title", $(this).text());
				//alert($(this).parent().get(0).rowIndex);輸出所在行
			}
		});
	});
</script>