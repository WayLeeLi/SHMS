<div>
	<h4>安全維護業務執行專區_後台</h4>
	<div class="date_time">
		<div class="date_box">
			<label>
				<input id="startDate" name="startDate" type="text" readonly="readonly" class="w_100p"
					placeholder="開始日期" />
				<i class="iconfont icon-riqi1"></i>
			</label>
		</div>
		<div class="date_box">
			<label>
				<input id="endDate" name="endDate" type="text" readonly="readonly" class="w_100p" placeholder="結束日期" />
				<i class="iconfont icon-riqi1"></i>
			</label>
		</div>
		<div class="date_box">
			<label>
				<input id="unitId_s" name="" type="text" class="w_100p" placeholder="連線代號" />
			</label>
		</div>
		<div class="date_box">
			<label>
				<input id="unitName_s" name="" type="text" class="w_100p" placeholder="銀行名稱" />
			</label>
		</div>
		<button class="btn btn-primary" id="getlist_search">查詢</button>
	</div class="m-t50 m-b30">
	<div id="jsGrid"></div>
	<div class="m-t50 m-b30">
		<h4>單位安全維護設施及設備</h4>
		<div class="date_box">
				<select name="deviceUnit" id="deviceUnit" class="custom-select ">
				
				</select>
			</div>
			<button class="btn btn-primary" id="getdevice_search">查詢</button>
		<div id="jsGrid_Device"></div>

		<br>
		<div style="text-align: center;">
			<button type="button" id="excel_dexport" class="btn btn-warning  my-2">完整匯出</button>
		</div>
	</div>
</div>


<style>
	/* 讓表格內容換行 */
	.jsgrid-table {
		word-wrap: break-word;
	}

	input[type=text] {
		width: 100%;
	}

	textarea {
		width: 100%;
	}
</style>

<script>
	//需要用的JS
	require(["jquery", "jquery_validate", "jsgrid", "jquery_ui"], function (jquery, jquery_validate, jsgrid, jquery_ui) {
		//頁面讀取後執行
		$(document).ready(function () {
			$.ajax({
					data: JSON.stringify({ "safetyNo": "" }),
					url: "/" + CONFIG.SYSTEM_NAME + '/safetyNotification/api/getInitData',
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "POST",
					success: function (data, textStatus) {
						if (data && data.code == 5000) {
							showAlert('沒有權限', '沒有權限', '')
						}if (data && data == 4000) {
							alert('您登入已逾時或未登入，請重新登入！')
							location.href = "/"+ CONFIG.SYSTEM_NAME + "/page/login.html";
						} else {
							console.log(data.unitList)
							createSelect("deviceUnit", data.unitList, "unitId", "unitName", '');
							$("#deviceUnit").first().prop('selected', true);
							
							

						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
				function createSelect(id, data, key, val, eventKey) {
				$.each(data, function (index, item) {
					$('#' + id).append($('<option>').val(item[key]).text(eventKey ? item[eventKey] + "_" + item[val] : item[val]));
					$('#' + id + '1').append($('<a>').html(item[val]).addClass('dropdown-item'));
				});
			}
			getByMenuId()
			function getByMenuId() {
			var menuid = 52;

			$.ajax({

				url: "/" + CONFIG.SYSTEM_NAME + '/buttonRole/api/getByMenuId?menuId=' + menuid,
				contentType: "application/json;charset=utf-8", // 因為上面是JSON
				async: false,
				cache: false,
				type: "GET",
				success: function (data, textStatus) {
					if (data && data.code == "5000") {
						//showAlert('沒有權限','沒有權限','')
						showAlert('沒有權限', '沒有權限', '')
					} else {
						var menuData = data.data
						get_list(menuData);
				
						console.log(menuData)
						// 		<button type="button" id='submit_o' class="btn btn-warning  my-2 pressing_hide tempButton">暫存</button>
						// <button type="button" id='submit_s' class="btn btn-primary  my-2 pressing_hide sendButton">儲存送出</button>
						// <button type="button" id="checkBtn" class="btn btn-success  my-2 pressing_hide reviewButton">審核通過</button>
						// <button type="button" id="return" class="btn btn-danger  my-2 pressing_hide returnButton">退件</button>
						// <button type="button" id='submit_p' class="btn btn-primary  my-2 pressing_show sendButton">儲存送出</button>
						// <button type="button" id="printBtn1" class="btn btn-secondary  my-2 pressing_show printButton">列印</button>
						// <button type="button" id="printBtn" class="btn btn-secondary  my-2 pressing_hide printButton">列印</button>

						if (menuData.functionArray.indexOf('review') < 0) {
							$('.reviewButton').hide()
						}
						if (menuData.functionArray.indexOf('temp') < 0) {
							$('.tempButton').hide()
						}
						if (menuData.functionArray.indexOf('reject') < 0) {
							$('.returnButton').hide()
						}
						if (menuData.functionArray.indexOf('temp') < 0) {
							$('.tempButton').hide()
						}
					}
				},
				error: function (data, textStatus, errorThrown) {
					console.log(data);
				},
			});
		}
			isLogin();//登入狀態
			function isLogin() {
				$.ajax({
					url: "/" + CONFIG.SYSTEM_NAME + '/login/api/getLogin',
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "get",
					success: function (data, textStatus) {
						if (data.msg != "success") {
							alert('您登入已逾時或未登入，請重新登入！')
							location.href = "/" + CONFIG.SYSTEM_NAME + "/page/login.html";

						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			};
			$('#startDate').datepicker({

				autoclose: true, //選擇後自動關閉
				dateFormat: 'yy/mm/dd',
				onClose: function( selectedDate ) {
        $( "#endDate" ).datepicker( "option", "minDate", selectedDate );
      },maxDate:0

			})

			$('#endDate').datepicker({

				autoclose: true, //選擇後自動關閉
				dateFormat: 'yy/mm/dd',

				minDate: $("#startDate").val(),
				onClose: function( selectedDate ) {
        $( "#startDate" ).datepicker( "option", "maxDate", selectedDate );
      }
			})
		
			get_listDevice()
			$('#getlist_search').click(function () {
				getByMenuId()
			})
			$('#get_listDevice').click(function () {
				get_listDevice()
			})
			$('#excel_dexport').click(function () {
				excel_dexport()
			})
			function get_list(menuData) {

				$.ajax({

					url: "/" + CONFIG.SYSTEM_NAME + '/safetyMaintenance/api/listAll?startDate=' + $('#startDate').val() + '&endDate=' + $('#endDate').val() + '&unitId=' + $('#unitId_s').val() + '&unitName=' + $('#unitName_s').val(),
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "GET",
					success: function (data, textStatus) {
						if (data && data.code == "5000") {
							showAlert('沒有權限', '沒有權限', '')
						} else {
							console.log(data)
							var data = data.data;
							console.log('1')
							
							//提示
							if(data!=''||data!=undefined){
								$.toast({ heading: '', text: '資料載入成功' + textStatus, icon: 'success', position: 'toast-top-center', hideAfter: 6000, });
							$("#jsGrid").jsGrid({
								width: "100%",
								height: "auto",
								heading: true, //是否顯示表頭
								filtering: false, //啟動查找
								inserting: false, //啟動新增  關掉使用自定義的
								editing: false,  //啟動編輯 
								selecting: true,
								sorting: true, //啟動排序
								paging: true, //啟動分頁 
								pageLoading: false, //是否支援分頁載入資料（相比較paging，這個屬性是向伺服器請求資料時要求分頁，而paging是本機進行分頁，無關伺服器）
								autoload: true,
								pageSize: 10,

								controller: {
									loadData: function (filter) {
										//查詢
										var result = $.grep(data, function (item, idx) {
											for (var key in filter) {
												var value = filter[key];
												if (value.length > 0) {
													if (!item[key]) {
														return false;
														callback(value.length)
													}

													if (typeof item[key] === 'number') {
														if (item[key].toString().indexOf(value) == -1) {
															return false;
															callback(item[key].toString().indexOf(value))
														}
													} else if (typeof item[key] === 'string') {
														if (item[key].indexOf(value) == -1) {
															return false;
															callback(item[key].indexOf(value))
														}
													}

												}

											}
											return true;
										});
										return result;
									},

								},
								fields: [

									{ title: "維護項目", name: "item", type: "text", validate: "required" },
									{ title: "總上傳數", name: "itemCount", type: "text", validate: "required" },
									{ title: "上傳期限", name: "endTime", type: "text", },
									{
										title: "下載", name: "item", type: "text", width: 100, filtercss: "display:none;", itemTemplate: function (value, item) {
											return $("<button>").attr("type", "button").text("").addClass("iconfont icon-exportexcel download-excel")
												.on("click", function () {
													if (menuData.functionArray.indexOf('export') < 0) {
															showAlert('無下載權限', '您沒有下載權限', '')
														} else {
															get_downDevice(item.itemType, item.itemYear, item.itemMonth, item.testNum);
														}
													
												});
										}, headerTemplate: function () {
											return "下載";
										}, filterTemplate: function () {
											return "";
										}
									},

								],


							});

							//依時間排序
							$("#jsGrid").jsGrid("sort", "safetyTime", "desc");
							}
							

						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			}
$('#getdevice_search').click(function (){
	get_listDevice()
})
			function get_listDevice() {

				$.ajax({

					url: "/" + CONFIG.SYSTEM_NAME + '/safetyMaintenanceDevice/api/listAll?unitId='+$('#deviceUnit').val(),
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "GET",
					success: function (data, textStatus) {
						if (data && data.code == "5000") {
							showAlert('沒有權限', '沒有權限', '')
						} else {
							var data = data.data;
							console.log('1')
							console.log(data)
							//提示
							$.toast({ heading: '', text: '資料載入成功' + textStatus, icon: 'success', position: 'toast-top-center', hideAfter: 6000, });
							$("#jsGrid_Device").jsGrid({
								width: "100%",
								height: "auto",
								heading: true, //是否顯示表頭
								filtering: false, //啟動查找
								inserting: false, //啟動新增  關掉使用自定義的
								editing: false,  //啟動編輯 
								selecting: true,
								sorting: true, //啟動排序
								paging: true, //啟動分頁 
								pageLoading: false, //是否支援分頁載入資料（相比較paging，這個屬性是向伺服器請求資料時要求分頁，而paging是本機進行分頁，無關伺服器）
								autoload: true,
								pageSize: 10,

								controller: {
									loadData: function (filter) {
										//查詢
										var result = $.grep(data, function (item, idx) {
											for (var key in filter) {
												var value = filter[key];
												if (value.length > 0) {
													if (!item[key]) {
														return false;
														callback(value.length)
													}

													if (typeof item[key] === 'number') {
														if (item[key].toString().indexOf(value) == -1) {
															return false;
															callback(item[key].toString().indexOf(value))
														}
													} else if (typeof item[key] === 'string') {
														if (item[key].indexOf(value) == -1) {
															return false;
															callback(item[key].indexOf(value))
														}
													}

												}

											}
											return true;
										});
										return result;
									},

								},
								fields: [
									{ title: "分行", name: "unitName", type: "text", validate: "required" },
									{ title: "設備名稱", name: "dvName", type: "text", validate: "required" },
									{ title: "自有或租賃", name: "selfLease", type: "text", validate: "required" },
									{ title: "廠商名稱", name: "comName", type: "text", },
									{ title: "契約簽訂情形", name: "signStatus", type: "text", },
									{ title: "更新日期", name: "upDate", type: "text", },
								],


							});


						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			}
			function excel_dexport() {
				window.location.href = "/" + CONFIG.SYSTEM_NAME + '/safetyMaintenanceDevice/api/export';
				// $.ajax({

				// 	url: "/" + CONFIG.SYSTEM_NAME + '/safetyMaintenanceDevice/api/export',
				// 	contentType: "application/json;charset=utf-8", // 因為上面是JSON
				// 	async: false,
				// 	cache: false,
				// 	type: "GET",
				// 	success: function (data, textStatus) {
				// 		if (data && data == "<script>alert('沒有權限')<\/script>") {
				// 			showAlert('沒有權限', '沒有權限', '')
				// 		} else {
				// 			console.log(data)
				// 			//提示
				// 			$.toast({ heading: '', text: '資料匯出成功' + textStatus, icon: 'success', position: 'toast-top-center', hideAfter: 6000, });
				// 		}
				// 	},
				// 	error: function (data, textStatus, errorThrown) {
				// 		console.log(data);
				// 	},
				// });
			}
			function get_downDevice(itemType, itemYear, itemMonth, testNum) {
				window.location.href = "/" + CONFIG.SYSTEM_NAME + '/safetyMaintenance/api/down?itemType=' + itemType + '&itemYear=' + itemYear + '&itemMonth=' + itemMonth + '&testNum=' + testNum
				// $.ajax({

				// 	url: "/" + CONFIG.SYSTEM_NAME + '/safetyMaintenance/api/down?itemType=' + itemType + '&itemYear=' + itemYear + '&endTime=' + endTime,
				// 	contentType: "application/json;charset=utf-8", // 因為上面是JSON
				// 	async: false,
				// 	cache: false,
				// 	type: "GET",
				// 	success: function (data, textStatus) {
				// 		if (data && data == "<script>alert('沒有權限')<\/script>") {
				// 			showAlert('沒有權限', '沒有權限', '')
				// 		} else {
				// 			console.log(data)
				// 			//提示
				// 			$.toast({ heading: '', text: '資料匯出成功' + textStatus, icon: 'success', position: 'toast-top-center', hideAfter: 6000, });



				// 		}
				// 	},
				// 	error: function (data, textStatus, errorThrown) {
				// 		console.log(data);
				// 	},
				// });
			}



			$("#tableDialog").dialog({
				title: "參數設定",
				autoOpen: false,
				width: 550,
				modal: true,
				open: function () {
					$('.ui-widget-overlay').addClass('custom-overlay');
					customCloseBtn();
				},
				close: function () {

					$("#dialogForm").find(".error").removeClass("error");
					$('.ui-widget-overlay').removeClass('custom-overlay');
				},
				classes: dlgSetting.classes,
				show: dlgSetting.show,
				hide: dlgSetting.hide
			});

			var formSubmitHandler = $.noop;

			var showDetailsDialog = function (dialogType, item) {

				$("#tableDialog").dialog("option", "title", dialogType + "").dialog("open");
			};

			$("#dialogForm").validate({
				//錯誤訊息元素預設為label改成p會換行
				errorElement: "p",
				rules: {
					cfgType: { required: true, rangelength: [2, 50] },
					cfgKey: { required: true, rangelength: [3, 80] },
					cfgName: { required: true, rangelength: [2, 50] },
					cfgValue: { required: true, rangelength: [0, 80] },
					cfgInUse: { required: true }
				},
				messages: {
					cfgType: {
						required: "請輸入參數類型",
						rangelength: "密碼長度不得小於2個字母大於50個字母"
					},
					cfgKey: {
						required: "請輸入參數key",
						rangelength: "參數key不得小於4個字母大於80個字母"
					},
					cfgName: {
						required: "請輸入參數名稱",
						rangelength: "參數名稱不得小於2個字母大於50個字母"
					},
					cfgValue: {
						required: "請輸入參數值",
						rangelength: "參數值不得小於0個字母大於80個字母"
					},
					cfgInUse: {
						required: "請選擇是否啟用"
					}
				},
				submitHandler: function () {
					formSubmitHandler();
				}
			});

			var saveItem = function (item, isNew) {
				$.extend(item, {
					cfgType: $("#cfgType").val(),
					cfgKey: $("#cfgKey").val(),
					cfgName: $("#cfgName").val(),
					cfgValue: $("#cfgValue").val(),
					cfgMemo: $("#cfgMemo").val(),
					cfgInUse: $('input[name*=cfgInUse]:checked').val()
				});

				$("#jsGrid").jsGrid(isNew ? "insertItem" : "updateItem", item);

				$("#tableDialog").dialog("close");
				bodyHref("/content/situation/Safetysituationreport.html");
			};

			function Processing(id) {
				bodyHref("/content/situation/Safetysituationreport_form7.html");
			}

		});


	});
</script>