<div class="row">
	<div id="divRoleList" class="divrole-tips">
		<h4>使用人員權限說明：</h4>
		<!--  
		<h5>1 總務</h5>
		<h5>2 職業安全衛生業務主管(副理) </h5>
		<h5>3 防火管理人</h5>
		<h5>4 急救人員</h5>
		<h5>5 單位主管(協理)</h5>
		<h5>6 襄理</h5>
		<h5>7 系統管理人員</h5>
		<h5>8 教育訓練管理人員</h5>
		<h5>9 全行員工</h5>
		<h5>10 醫護人員</h5>-->
	</div>
	<div id="jsGrid">

		<table id="authTable">

		</table>
	</div>
	<div>
		<button id="btnChange" class="btn btn-primary">修改</button>
	</div>
</div>
<div id="template_checkbox" style="display:none;" class="custom-control custom-checkbox">
	<input type='checkbox' class='custom-control-input' id="@INPUT_ID@" name="@INPUT_NAME@" value="@INPUT_VALUE@" />
	<label class='custom-control-label' for="@INPUT_ID@">@LABEL@</label>
</div>
<div id="detailDialog" style="display:none" class="container">
	<div>
		<!-- <h2 style="text-align: center;"><span class="menu"></span>---<span class="member"></span></h2> -->
		<input type="hidden" id="menuIdx">
		<input type="hidden" id="levelx">
		<br>

		<form id="buttonRole">
			<div class="jsgrid-grid-header jsgrid-header-scrollbar">
				<table id="getByMenuIdAndLevel" class="jsgrid-table">
					<!-- 暫存 temp 發佈 send 編輯 edit 刪除 delete 查看 view 處理 process 審核 review 退件 reject 
				列印 print 匯出 export 匯入 import 轉置 trans 追蹤 track -->

				<thead style="display: none;">
					<tr class="jsgrid-header-row">
					
					

						<td class="jsgrid-cell text-center">查看</td>
						<td class="jsgrid-cell text-center">
							<div class="checkbox_plus"><input type="checkbox" disabled checked id="view" value="view"
									name="buttonRole_c"></div>
						</td>
						<td class="jsgrid-cell text-center">列印</td>
						<td class="jsgrid-cell text-center">
							<div class="checkbox_plus"><input type="checkbox" disabled checked id="print" value="print"
									name="buttonRole_c"></div>
						</td>

						
					</tr>
				</thead>
					<tbody>
						<tr class="jsgrid-header-row">
							<td class="jsgrid-cell text-center">暫存</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="temp" value="temp"
										name="buttonRole_c"></div>
							</td>

							<td class="jsgrid-cell text-center">發佈</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="send" value="send"
										name="buttonRole_c"></div>
							</td>

							<td class="jsgrid-cell text-center">編輯</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="edit" value="edit"
										name="buttonRole_c"></div>
							</td>

							<td class="jsgrid-cell text-center">刪除</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="delete" value="delete"
										name="buttonRole_c"></div>
							</td>

						

							<td class="jsgrid-cell text-center">處理</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="process" value="process"
										name="buttonRole_c"></div>
							</td>
						</tr>
						<tr class="jsgrid-alt-row">
							<td class="jsgrid-cell text-center">審核</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="review" value="review"
										name="buttonRole_c"></div>
							</td>

							<td class="jsgrid-cell text-center">退件</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="reject" value="reject"
										name="buttonRole_c"></div>
							</td>

						

							<td class="jsgrid-cell text-center">匯出</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="export" value="export"
										name="buttonRole_c"></div>
							</td>

							<td class="jsgrid-cell text-center">匯入</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="import" value="import"
										name="buttonRole_c"></div>
							</td>

							<td class="jsgrid-cell text-center">轉置</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="trans" value="trans"
										name="buttonRole_c"></div>
							</td>
						</tr>
						<tr class="jsgrid-header-row">
							<!-- <td class="jsgrid-cell text-center">追蹤</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" checked disabled id="track" value="track"
										name="buttonRole_c"></div>
							</td> -->
							<td class="jsgrid-cell text-center">新增</td>
							<td class="jsgrid-cell text-center">
								<div class="checkbox_plus"><input type="checkbox" id="add" value="add"
										name="buttonRole_c"></div>
							</td>
						</tr>
					</tbody>
				</table>
			</div>
		</form>
	</div>

	<div style="text-align: center;">
		<button type="button" id="rolesbutton_submit" class="btn btn-success  my-2">送出</button>

	</div>
</div>
<script>
	//需要用的JS
	require(["jquery", "jsgrid"], function (jquery, jsgrid) {
		//頁面讀取後執行
		$(document).ready(function () {
			let roles = ["","1 總務", "2 職業安全衛生<br>業務主管(副理)" , "3 防火管理人" , "4 急救人員" , "5 單位主管(協理)" , "6 襄理" , "7 系統管理人員", "8 教育訓練管理人員", "9 全行員工", "10 醫護人員", "11 職安人員"];
			roles.forEach((e) => {
				$("#divRoleList").append(`<h5>${e}</h5>`);
			});
			$.ajax({
				url: "/" + CONFIG.SYSTEM_NAME + '/auth/api/getAuthorizastion',
				contentType: "application/json;charset=utf-8", // 因為上面是JSON
				async: false,
				cache: false,
				type: "GET",
				success: function (data, textStatus) {

					var table = document.getElementById("authTable");
					var rowCount = 0;
					var cellCount = roles.length - 1;
					var row0 = table.insertRow(rowCount);
					rowCount++;
					row0.className = "jsgrid-header-row sticky-top";
					var cell0 = row0.insertCell(0);
					cell0.className = "jsgrid-header-cell";
					for (var i = 1; i <= cellCount; i++) {
						var cell = row0.insertCell(i);
						cell.innerHTML = roles[i];
						cell.className = "jsgrid-header-cell";
					};
					$.each(data.menuList, function (index, item) {
						var row = table.insertRow(rowCount);
						rowCount++;
						row.className = (index % 2 == 0 ? "jsgrid-row" : "jsgrid-alt-row");
						for (var i = 0; i <= cellCount; i++) {
							var cell = row.insertCell(i);
							cell.className = "jsgrid-cell text-center";
							if (i == 0) {
								cell.innerHTML = item.MENU_NAME;
							} else {
								var key = item.ID + "_" + i;
								var chk = document.createElement('input'); // CREATE CHECK BOX.
								chk.setAttribute('type', 'checkbox'); // SPECIFY THE TYPE OF ELEMENT.
								chk.setAttribute('id', 'auth_' + i); // SET UNIQUE ID.
								chk.setAttribute('value', key);
								chk.setAttribute('name', "authCheckbox");
								chk.setAttribute("style", "zoom:1.5;");
								if (data.authKeyMap.hasOwnProperty(key)) {
									chk.setAttribute("checked", "checked");

								}

								cell.appendChild(chk);
								if (data.authKeyMap.hasOwnProperty(key)) {

									var chkbtn = document.createElement('input');
									chkbtn.setAttribute('type', 'button'); // SPECIFY THE TYPE OF ELEMENT.
									chkbtn.setAttribute('id', 'authbtn_' + key); // SET UNIQUE ID.
									chkbtn.setAttribute('value', '按鈕權限');
									chkbtn.setAttribute('key', key);
									chkbtn.setAttribute("style", "display: block;width: 100%;");
									chkbtn.setAttribute('class', "btn btn-primary authbtn");
									cell.appendChild(chkbtn);
								}

							}
						}
					});

				},
				error: function (data, textStatus, errorThrown) {
					console.log(data);
				},
			});
			$('.authbtn').click(function () {
				var key = $(this).attr('key');
				console.log(key)
				showDetailsDialog('按鈕權限', key)
			})
			$('#rolesbutton_submit').click(function () {
				var rolesbutton = [];
				$('input[name="buttonRole_c"]:checked').each(
					function () {
						rolesbutton.push($(this).val());
					}

				)
				var functionArray = rolesbutton.toString();
				var saveItem = {
					jobLevel: $('#levelx').val(),
					menuId: $('#menuIdx').val(),
					functionArray: functionArray,
					status: "y"
				}
				$.ajax({
					url: "/" + CONFIG.SYSTEM_NAME + '/buttonRole/api/save',
					data: JSON.stringify(saveItem),
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "POST",
					success: function (data, textStatus) {
						if (data && data.code == 5000) {
					
							showAlert('沒有權限', '沒有權限', '')
						} else {
							if (data.msg == "success") {
								showAlert('更新成功', '按鈕權限已更新成功！', bodyHref("/content/setting/authorizastionSetting.html"))
							} else {
								showAlert('更新失敗', '按鈕權限更新失敗！', '')
							}
						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			})
			var showDetailsDialog = function (dialogType, item) {
				var menuId = item.split("_")[0]
				var level = item.split("_")[1]
				$('#menuIdx').val(menuId);
				$('#levelx').val(level);
				console.log("/" + CONFIG.SYSTEM_NAME + '/buttonRole/api/getByMenuIdAndLevel?menuId=' + menuId + '&level=' + level)
				$("#detailDialog").dialog("option", "title", dialogType + "").dialog("open");
				$('#safetyId').val(item)
				$.ajax({
					url: "/" + CONFIG.SYSTEM_NAME + '/buttonRole/api/getByAuthAndMenu?menuId=' + menuId + '&level=' + level,
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "GET",
					success: function (data, textStatus) {
						if(data && data.code != "1001"){
							if (data && data.code == "5000") {
							showAlert('沒有權限', '沒有權限', '')
						} else {
							var data = data.data;
							console.log(data.functionArray);
							// 			<!-- 暫存 temp 發佈 send 編輯 edit 刪除 delete 查看 view 處理 process 審核 review 退件 reject 
							// 列印 print 匯出 export 匯入 import 轉置 trans 追蹤 track -->
							let rolesx = ["暫存", "發佈", "編輯", "刪除", "查看", "處理", "審核", "退件", "列印", "匯出", "匯入", "轉置", "追蹤"];
							let rolesxX = ["temp", "send", "edit", "delete", "view", "process", "review", "reject", "print", "export", "import", "trans", "track"];
							console.log(rolesxX);
							var dataArr = data.functionArray.split(',')
							
							$.each(dataArr, function (index, item) {
								console.log(item)
								$('input[id="' + item + '"]').attr('checked', 'checked')
								// var key = item.ID + "_" + i;
								// var chk = document.createElement('input'); // CREATE CHECK BOX.
								// chk.setAttribute('type', 'checkbox'); // SPECIFY THE TYPE OF ELEMENT.
								// chk.setAttribute('id', 'auth_' + i); // SET UNIQUE ID.
								// chk.setAttribute('value', key);
								// chk.setAttribute('name', "authCheckbox");
								// chk.setAttribute("style", "zoom:1.5;");
								// if (data.authKeyMap.hasOwnProperty(key)) {
								// 	chk.setAttribute("checked", "checked");
								// }
								// cell.appendChild(chk);
							});
						}
					}
					}
				});
			};
			//查看
			$("#detailDialog").dialog({
				title: "參數設定",
				autoOpen: false,
				width: 960,
				height: 550,

				modal: true,
				close: function () {
					bodyHref("/content/setting/authorizastionSetting.html")
					// $("#getByMenuIdAndLevel tbody input[type='checkbox']").prop('checked', false);
				},
				open: function (event, ui) {
					$('.ui-widget-overlay').addClass('custom-overlay');
					customCloseBtn();
				},
				classes: dlgSetting.classes,
				show: dlgSetting.show,
				hide: dlgSetting.hide
			});
			$("#btnChange").click(function () {
				var dataList = [];
				$('input[name="authCheckbox"]:checked').each(function () {
					dataList.push(this.value);
				});
				$.ajax({
					url: "/" + CONFIG.SYSTEM_NAME + '/auth/api/updateAuthorizastion',
					data: JSON.stringify(dataList),
					contentType: "application/json;charset=utf-8", // 因為上面是JSON
					async: false,
					cache: false,
					type: "POST",
					success: function (data, textStatus) {
						if (data && data == "<script>alert('沒有權限')<\/script>") {
							alert("沒有權限");
						} else {
							if (data.result == "success") {
								showAlert('更新成功', '已更新成功！', bodyHref("/content/setting/authorizastionSetting.html"))
								bodyHref("/content/setting/authorizastionSetting.html")
							} else {
								alert("更新失敗");
							}
						}
					},
					error: function (data, textStatus, errorThrown) {
						console.log(data);
					},
				});
			});

		});
	});
</script>
