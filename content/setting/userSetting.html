<div>
	<h4>使用者設定</h4>
	<div style="text-align: left;">
		<button type="button" id="syncADBtn" class="btn btn-secondary">同步AD</button>
		<button type="button" id="exportPersonUnitBtn" class="btn btn-secondary">匯出人員單位對照表</button>
	</div>
	
	    <div id="jsGrid"></div>
</div>

<div id="tableDialog" style="display:none" class="container">
    <form id="dialogForm">
        <div class="details-form-field row">
			<div class="col text-right"><label for="rocId">身分證字號</label></div>
			<div class="col-8 align-self-center"><input id="rocId" name="rocId" type="text" /></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="name">姓名</label></div>
			<div class="col-8 align-self-center"><input id="name" name="name" type="text" /></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="account">帳號</label></div>
			<div class="col-8 align-self-center"><input id="account" name="account" type="text" /></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="unitId">單位代號</label></div>
			<div class="col-8 align-self-center"><input id="unitId" name="unitId" type="text" /></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="jobName">職稱</label></div>
			<div class="col-8 align-self-center"><input  id="jobName" name="jobName"  type="text"/></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="jobLevel">職等</label></div>
			<div class="col-8 align-self-center"><input  id="jobLevel" name="jobLevel"  type="text"/></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="phone">phone</label></div>
			<div class="col-8 align-self-center"><input  id="phone" name="phone"  type="text"/></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="email">email</label></div>
			<div class="col-8 align-self-center"><input  id="email" name="email"  type="text"/></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="birthday">birthday</label></div>
			<div class="col-8 align-self-center"><input  id="birthday" name="birthday"  type="text"/></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"><label for="isLeave">是否離職</label></div>
			<div class="col-8 align-self-center"><input  id="isLeave" name="isLeave"  type="text"/></div>
        </div>
        <div class="details-form-field row">
			<div class="col text-right"></div>
			<div class="col-7"><button type="submit" id="dialogFormSubmit" class="btn btn-primary">送出</button></div>
        </div>
    </form>
</div>

<style>
/* 讓表格內容換行 */
.jsgrid-table{
		word-wrap:break-word;
	}
input[type=text]{
	width: 100%;
}
</style>

<script>
//需要用的JS
require(["jquery", "jquery_validate_addition", "jquery_validate", "jsgrid", "jquery_ui", "toast"], function (jquery, jquery_validate, jsgrid, jquery_ui, toast ) {
	//頁面讀取後執行
	$(document).ready(function(){

		function desensitizeName(name) {
        if (name.length <= 1) return name; 
        const firstChar = name[0]; 
        if (name.length === 2) {
            return firstChar + "O"; 
        } else {
            const lastChar = name.slice(-1); 
            const middle = "O".repeat(name.length - 2); 
            return firstChar + middle + lastChar;
        }
    }
		 $.ajax({
			    url: "/"+CONFIG.SYSTEM_NAME + '/user/api/getUser',
			    contentType: "application/json;charset=utf-8", // 因為上面是JSON
			    async: false,
			    cache: false,
			    type: "GET",
			    success: function(data, textStatus){    
			    	 if(data && data == "<script>alert('沒有權限')<\/script>"){
			    		 alert("沒有權限");
			    	 }else{
			    	 	$("#jsGrid").jsGrid({
			    	        width: "100%",
			    	        height: "auto",
			    	        heading: true, //是否顯示表頭
			    		    filtering: true, //啟動查找
			    		    inserting: false, //啟動新增  關掉使用自定義的
			    		    editing: true,  //啟動編輯 
			    		    selecting: true,
			    		    sorting: true, //啟動排序
			    		    paging: true, //啟動分頁 
			    		    pageLoading: false, //是否支援分頁載入資料（相比較paging，這個屬性是向伺服器請求資料時要求分頁，而paging是本機進行分頁，無關伺服器）
			    		    autoload: true,
			    		    pageSize: 10,
			    		    
			    		    controller: {
			    		        loadData: function(filter) {
				    		        	//查詢
			    		        	 	var result = $.grep(data, function(item, idx) {
			    		                    for (var key in filter) {
			    		                        var value = filter[key];
			    		                        if (value.length > 0) {
			    		                        	if (!item[key]){
			    		                                return false;
			    		                        	}
			    		                        	if(typeof item[key] === 'number'){
			    		                        		if (item[key].toString().indexOf(value) == -1){
				    		                                return false;
			    		                        		}
			    		                        	}else if(typeof item[key] === 'string'){
			    		                        		if (item[key].indexOf(value) == -1){
				    		                                return false;
			    		                        		}
			    		                        	}
			    		                        	
			    		                        }
			    		                    }
			    		                    return true;
			    		                });
			    		            return result;
			    		        },
			    		        insertItem: function(insertingItem) {
			    		        	$.ajax({
			    		 			    url: "/"+CONFIG.SYSTEM_NAME + '/user/api/addUser',
			    		 			    data: JSON.stringify(insertingItem),
			    		 			    contentType: "application/json;charset=utf-8", // 因為上面是JSON
			    		 			    async: false,
			    		 			    cache: false,
			    		 			    type: "POST",
			    		 			    success: function(data, textStatus){   
			    		 			    	 if(data && data == "<script>alert('沒有權限')<\/script>"){
			    					    		 alert("沒有權限");
			    					    	 }else{
			    					    		 if(data.result == "success"){
			    					    			 insertingItem.id = data.id;
			    					    			 alert("新增成功");
			    					    		 }else if(data.errorMsg){
			    					    			 alert(data.errorMsg);
			    					    		 }
			    					    	 }
			    		 			    },
			    		 			    error: function (data, textStatus, errorThrown) {
			    		 			        console.log(data);
			    		 			    },
			    		 			});
			    		        },
			    		        updateItem: function(updatingItem) { 
			    		        	$.ajax({
			    		 			    url: "/"+CONFIG.SYSTEM_NAME + '/user/api/updateUser',
			    		 			    data: JSON.stringify(updatingItem),
			    		 			    contentType: "application/json;charset=utf-8", // 因為上面是JSON
			    		 			    async: false,
			    		 			    cache: false,
			    		 			    type: "POST",
			    		 			    success: function(data, textStatus){   
			    		 			    	 if(data && data == "<script>alert('沒有權限')<\/script>"){
			    					    		 alert("沒有權限");
			    					    	 }else{
			    					    		 if(data.result == "success"){
			    					    			 alert("更新成功");
			    					    		 }else if(data.errorMsg){
			    					    			 alert(data.errorMsg);
			    					    		 }
			    					    	 }
			    		 			    },
			    		 			    error: function (data, textStatus, errorThrown) {
			    		 			        console.log(data);
			    		 			    },
			    		 			});
			    		        },
			    		        deleteItem: function(deletingItem) {
			    		        	 $.ajax({
			    		 			    url: "/"+CONFIG.SYSTEM_NAME + '/user/api/deleteUser',
			    		 			    data: '{"ID":' + deletingItem.id + '}',
			    		 			    contentType: "application/json;charset=utf-8", // 因為上面是JSON
			    		 			    async: false,
			    		 			    cache: false,
			    		 			    type: "POST",
			    		 			    success: function(data, textStatus){   
			    		 			    	 if(data && data == "<script>alert('沒有權限')<\/script>"){
			    					    		 alert("沒有權限");
			    					    	 }else{
			    					    		 if(data.result == "success"){
			    					    			 alert("刪除成功");
			    					    		 }else if(data.errorMsg){
			    					    			 alert(data.errorMsg);
			    					    		 }
			    					    	 }
			    		 			    },
			    		 			    error: function (data, textStatus, errorThrown) {
			    		 			        console.log(data);
			    		 			    },
			    		 			});
			    		        }
			    		    },
			    	 
			    	        fields: [
			    	            { title:"身分證字號", name: "rocId", type: "text", width: 110, itemTemplate: function(value, item){ return `<div>${maskID(value)}</div>`;}},
			    	            { title:"姓名", name: "name", type: "text", width: 140 , itemTemplate: function(value, item){ 
									
									const originalName = value;
        const maskedName = desensitizeName(originalName);
        $(this).text(maskedName);
		return maskedName;
		// return `<div>${maskID(value)}</div>`;
								}},
			    	            { title:"帳號", name: "account", type: "text", width: 140 },
			    	            { title:"單位代號", name: "unitId", type: "text", width: 90 },
			    	            { title:"職稱", name: "jobName", type: "text", width: 130 },
			    	            { title:"職等", name: "jobLevel", type: "text", width: 60 },
			    	            { title:"phone", name: "phone", type: "text", width: 120 },
			    	            { title:"email", name: "email", type: "text", width: 120 },
			    	            { title:"birthday", name: "birthday", type: "text", width: 100 },
			    	            { title:"是否離職", name: "isLeave", type: "text", width: 60 },
			    	            { type: "control",
			                        editButton: false,
			                        modeSwitchButton: false,
			                        headerTemplate: function() {
			                            return $("<button>").attr("type", "button").text("新增").addClass("btn btn-primary")
			                                .on("click", function () {
			                                	showDetailsDialog("新增", {});
			                                });
			                        }
			    	            }             
			    	        ],
				    	 	rowClick: function(args) {
				    	 		 showDetailsDialog("修改", args.item);
				            },
			    		    deleteConfirm: function(item) {
			                    return "人員 \"" + item.name + "\" 確認刪除?";
			                },
				            
			    	    });
			    	 }
			    },
			    error: function (data, textStatus, errorThrown) {
			        console.log(data);
			    },
			});
	
		 $("#tableDialog").dialog({
			 title: "參數設定",
	         autoOpen: false,
	         width: 550,
	         modal: true,
	         close: function() {
	             $("#dialogForm").validate().resetForm();
	             $("#dialogForm").find(".error").removeClass("error");
	             $('.ui-widget-overlay').removeClass('custom-overlay');
	         },
             open: function(){
            	 $('.ui-widget-overlay').addClass('custom-overlay');
            	 customCloseBtn();
             },
             classes: dlgSetting.classes,
	         show: dlgSetting.show,
			 hide: dlgSetting.hide
	     });
		 
		 var formSubmitHandler = $.noop;
		 
		 var showDetailsDialog = function(dialogType, item) {
             $("#rocId").val(item.rocId);
             $("#name").val(item.name);
             $("#account").val(item.account);
             $("#unitId").val(item.unitId);
             $("#jobName").val(item.jobName);
             $("#jobLevel").val(item.jobLevel);
             $("#phone").val(item.phone);
             $("#email").val(item.email);
             $("#birthday").val(item.birthday);
             $("#isLeave").val(item.isLeave);
             if(dialogType === "修改"){
            	 $("#rocId").attr("disabled", true);
             }
             formSubmitHandler = function() {
            	 saveItem(item, dialogType === "新增");
             };

             $("#tableDialog").dialog("option", "title", dialogType + " user").dialog("open");
         };
	
	     $("#dialogForm").validate({
	    	 //錯誤訊息元素預設為label改成p會換行
			 errorElement: "p",
	         rules: {
	        	 rocId: { required: true, rangelength: [2, 30] },
	        	 name: { required: true, rangelength: [2, 30] },
	        	 account: { required: true, rangelength: [2, 30] },
	        	 unitId: { required: true, rangelength: [2, 30] },
	        	 jobName: { required: true, rangelength: [2, 30] },
	        	 jobLevel: { required: true, range: [1, 99] },
	        	 isLeave: { required: true, range: [0, 1] },
	        	 phone:{ required: true, phoneTW: true}
	         },
	         messages: {
	        	 	rocId:{
			          required: "請輸入身分證字號",
			          rangelength: "長度不得小於2個字母大於30個字母"
			        },
			        name:{
			          required: "請輸入姓名",
			          rangelength: "長度不得小於2個字母大於30個字母"
			        },
			        account:{
			          required: "請輸入帳號",
			          rangelength: "長度不得小於2個字母大於30個字母"
			        },
			        unitId:{
			          required: "請輸入單位代號",
			          rangelength: "長度不得小於2個字母大於20個字母"
			        },
			        jobName:{
			          required: "請輸入職稱",
			          rangelength: "長度不得小於2個字母大於30個字母"
			        },
			        jobLevel:{
			          required: "請輸入職等",
			          range: "不得小於1大於99"
			        },
			        isLeave:{
			          required: "請輸入是否離職",
			          range: "0或1"
			        }
	         },
	         submitHandler: function() {
	             formSubmitHandler();
	         }
	     });
	     
	     var saveItem = function(item, isNew) {
             $.extend(item, {
            	 rocId: $("#rocId").val(),
            	 name: $("#name").val(),
            	 account: $("#account").val(),
            	 unitId: $("#unitId").val(),
            	 jobName: $("#jobName").val(),
            	 jobLevel: $("#jobLevel").val(),
            	 phone: $("#phone").val(),
            	 email: $("#email").val(),
            	 birthday: $("#birthday").val(),
            	 isLeave: $("#isLeave").val()
             });
             
             $("#jsGrid").jsGrid(isNew ? "insertItem" : "updateItem", item);
             $("#tableDialog").dialog("close");
             bodyHref("/content/setting/userSetting.html");
         };
	
         $("#syncADBtn").on("click", function(){
        	 $.ajax({
     			url: "/"+ CONFIG.SYSTEM_NAME + "/login/api/addUserAndUnitTest",
     		    cache: false,
     		    async: true,
     		    type: "GET",
     		    success: function(res, status, xhr) { 
     		    	
     		    	if(res.result != "success"){
     		    		
     		    		alert(res);
     		    	}
     		    	else{
     		    		alert("資料同步成功");
     		    	}
     		    	console.log(res);
     		    },
     		    error: function (data, textStatus, errorThrown) {
     		    	alert(data);
     		    	console.log(data);
     		    }
     		});
         });
	    
         
         $("#exportPersonUnitBtn").on("click", function(){
        	 exportExcel("/"+CONFIG.SYSTEM_NAME + '/user/api/downloadUserUnit');
         });
	});
});
</script>
